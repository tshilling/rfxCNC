<!DOCTYPE html>
<html lang="en">
<head>
    <title>RFX CONTROL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="default.css"> <!-- custom css styling-->
</head>

<body>
    <div class="rfx-panel" style="max-width: 400px; margin:auto">
        <label id="header-label">Wifi</label>
        <div>
            <label><b>Name on network</b></label>
            <input id="dns_name" class="rfx-input" type="text" placeholder="Access server via name">
            <label><b>SSID</b></label>
            <input id="ssid" class="rfx-input" type="text" placeholder="Wifi Network Name">
            <label><b>Password</b></label>
            <input id="password" class="rfx-input" type="password" placeholder="Wifi Password">
            <button id="submit-button" class="rfx-button" style="width:100%;"
                onclick="submit()">Submit</button>
        </div>
    </div>
</body>

<script>
    document.querySelectorAll('.rfx-input').forEach(item => {
        item.addEventListener('change', event => {
            console.log("change")
            function mark(el) {
                with (el.classList) {
                    remove("rfx-good")
                    add("rfx-caution")
                    remove("rfx-warning")
                }
            }
            mark(item)
            mark(document.getElementById('submit-button'))
            document.getElementById('header-label').innerText = "Wifi Settings: Need to submit"
        })
    })
    function getServerInfo() {
        var xhr = new XMLHttpRequest();
        xhr.onload = () => {
            let response = JSON.parse(xhr.responseText)
            document.getElementById("dns_name").placeholder = response.dns_name;
            document.getElementById("ssid").placeholder = response.ssid;
        };
        xhr.onerror = () => {
            setTimeout(getServerInfo, 1000);
        }
        xhr.open("GET", "http://192.168.4.62/server/status", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send();
    }
    function submit() {
        let data = {};
        // Build json data packet 
        document.querySelectorAll('.rfx-input').forEach(item => {
            data[item.id] = item.value;
        })
        var xhr = new XMLHttpRequest();
        function bad_response() {
            function mark(el) {
                with (el.classList) {
                    remove("rfx-good")
                    remove("rfx-caution")
                    add("rfx-warning")
                }
            }
            mark(document.getElementById('submit-button'))
        }
        xhr.onload = () => {
            if (xhr.response === 'ok') {
                function mark(el) {
                    with (el.classList) {
                        add("rfx-good")
                        remove("rfx-caution")
                        remove("rfx-warning")
                    }
                }
                mark(document.getElementById('submit-button'))
                document.getElementById('header-label').innerText = "Wifi Settings: Saved"
                document.querySelectorAll('.rfx-input').forEach(item => {
                    item.classList.remove("rfx-good")
                    item.classList.remove("rfx-caution")
                    item.classList.remove("rfx-warning")
                })
            }
            else {
                document.getElementById('header-label').innerText = "Wifi Settings: Error- Bad Response";
                bad_response()
            }

        };
        xhr.onerror = () => {
            document.getElementById('header-label').innerText = "Wifi Settings: Error- Server";
            bad_response()
        }
        xhr.ontimeout = () => {
            document.getElementById('header-label').innerText = "Wifi Settings: Error- Server Unreachable";
            bad_response()
        }
        xhr.timeout = 2000
        xhr.open("POST", "/server/settings", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        console.log(JSON.stringify(data))
        xhr.send(JSON.stringify(data));
    }
    getServerInfo();
</script>