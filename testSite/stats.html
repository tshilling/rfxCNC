<!DOCTYPE html>
<html lang="en">

<head>
    <title>RFX CONTROL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="default.css"> <!-- custom css styling-->
</head>

<body>
    <div class="rfx-panel" style="max-width: 400px; margin:auto">
        <label id="header-label">RFX-ESP</label>
        <div>
            <div style="margin-bottom: 8px;">
                <label><b>Firmware / Ver: </b></label>
                <label id="version" style="float:right">NULL</label>
                <label style="float:right; padding:0 4px 0 4px"> - </label>
                <label id="firmware" style="float:right">NULL</label>
            </div>
            <div class="rfx-panel" style="max-width: 400px; margin:auto; margin-bottom: 8px;">
                <label id="network-label" style="color:black;background-color: lightgray;">Network</label>
                <div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>IP / Name: </b></label>
                        <label id="server_name" style="float:right">NULL</label>
                        <label style="float:right; padding:0 4px 0 4px"> - </label>
                        <label id="server_ip" style="float:right">NULL</label>
                    </div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>Mode: </b></label>
                        <label id="server_mode" style="float:right">NULL</label>
                    </div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>WiFi SSID: </b></label>
                        <label id="server_ssid" style="float:right">NULL</label>
                    </div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>Ping (msec): </b></label>
                        <label style="float:right"><b id="server_ping"  style="filter: brightness(80%);">NULL</b></label>
                    </div>
                </div>
            </div>
            <div class="rfx-panel" style="max-width: 400px; margin:auto">
                <label id="header-label">CPU</label>
                <div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>CPU Freq (MHz): </b></label>
                        <label id="server_freq" style="float:right">NULL</label>
                    </div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>Up Time (sec): </b></label>
                        <label id="up_time" style="float:right">NULL</label>
                    </div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>Filesystem Used/Total (kb): </b></label>
                        <label id="total_bytes" style="float:right">NULL</label>
                        <label style="float:right; padding:0 4px 0 4px"> / </label>
                        <label id="used_bytes" style="float:right">NULL</label>
                    </div>
                    <div style="border-bottom: 2px solid lightgray;">
                        <label><b>RAM Used/Total(kb): </b></label>
                        <label id="server_total_heap" style="float:right">NULL</label>
                        <label style="float:right; padding:0 4px 0 4px"> / </label>
                        <label id="server_used_heap" style="float:right">NULL</label>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>
<script>
    function update_server_status(status) {
        let color = "lightCoral";
        if (status == "ok") {
            color = "lightGreen"
        }
        if (status == "caution") {
            color = "Khaki"
        }
        document.getElementById("network-label").style.backgroundColor = color
        document.getElementById("server_ping").style.color = color
    }
    function getServerInfo() {
        var xhr = new XMLHttpRequest();
        let start_date = new Date();
        xhr.onload = () => {
            let end_date = new Date();
            let millis = end_date.getTime() - start_date.getTime();
            let response = JSON.parse(xhr.responseText)
            document.getElementById("firmware").innerText  = response.firmware;
            document.getElementById("version").innerText  = response.version;

            document.getElementById("server_ip").innerText = response.ip;
            document.getElementById("server_name").innerText = response.dns_name;
            document.getElementById("server_mode").innerText = response.mode;
            document.getElementById("server_ssid").innerText = response.ssid;
            document.getElementById("server_ping").innerText = millis;

            document.getElementById("up_time").innerText = Math.round(response.up_time / 1000)
            document.getElementById("total_bytes").innerText = Math.round(response.total_bytes / 1000)
            document.getElementById("used_bytes").innerText = Math.round(response.used_bytes / 1000)

            let total_heap = response.total_heap;
            let free_heap = response.free_heap;
            document.getElementById("server_total_heap").innerText = Math.round(total_heap / 1000);
            document.getElementById("server_used_heap").innerText = Math.round((total_heap-free_heap) / 1000);

            document.getElementById("server_freq").innerText = response.freq;
            if (millis < 250)
            {
                update_server_status("ok");
                document.getElementById("network-label").innerText = "Network";
            }
            else if (millis < 750){
                update_server_status("caution");
                document.getElementById("network-label").innerText = "Network";
            }
            else{
                update_server_status("warning");
                document.getElementById("network-label").innerText = "Network - Slow response (ping)";
            }
            
            setTimeout(getServerInfo, 1000);
        };
        xhr.onerror = () => {
            update_server_status("warning");
            document.getElementById("server_ping").innerText = "error";
            document.getElementById("network-label").innerText = "Network - Error";
            setTimeout(getServerInfo, 1000);
        }
        xhr.timeout = 2000;
        xhr.ontimeout = () => {
            update_server_status("warning");
            document.getElementById("server_ping").innerText = "timeout";
            document.getElementById("network-label").innerText = "Network - Timeout";
            setTimeout(getServerInfo, 1000);
            document.getElementById("server").classList.add("w3-disabled");
        }
        xhr.open("GET", "/server/status", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send();
        }
        setTimeout(getServerInfo, 1000);
</script>