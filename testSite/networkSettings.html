<!DOCTYPE html>
<html lang="en">

<head>
    <title>RFX CONTROL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="rfx.css"> <!-- custom css styling-->
</head>

<body>
    <div class="rfx-panel">
        <label id="header-label">Wifi Settings</label>
        <div>
            <label><b>Name on network</b></label>
            <input id="dns_name" class="rfx-input" type="text" placeholder="Access server via name">
            <label><b>SSID</b></label>
            <input id="ssid" class="rfx-input" type="text" placeholder="Wifi Network Name">
            <label><b>Password</b></label>
            <input id="password" class="rfx-input" type="password" placeholder="Wifi Password">
        </div>
    </div>
    <button id="submit-button" class="rfx-button" style="width:100%;font-size: 1.5rem;" onclick="submit()">Submit</button>
</body>
<script>
    document.querySelectorAll('.rfx-input').forEach(item => {
        item.addEventListener('change', event => {
            item.classList.remove("rfx-good")
            item.classList.add("rfx-caution")

            let el = document.getElementById('submit-button')
            el.classList.remove("rfx-good")
            el.classList.add("rfx-caution")
            el.classList.remove("rfx-warning")
            el = document.getElementById('header-label');
            el.innerText = "Wifi Settings: Need to submit"
            el.classList.remove("rfx-good")
            el.classList.add("rfx-caution")
            el.classList.remove("rfx-warning")
        })
    })
    function getServerInfo() {
        var xhr = new XMLHttpRequest();
        xhr.onload = () => {
            let response = JSON.parse(xhr.responseText)
            document.getElementById("dns_name").placeholder = response.dns_name;
            document.getElementById("ssid").placeholder = response.ssid;
        };
        xhr.onerror = () => {
            setTimeout(getServerInfo, 1000);
        }
        xhr.open("GET", "http://192.168.4.62/server/status", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send();
    }
    function submit(){
        let data = {};
        // Build json data packet 
        document.querySelectorAll('.rfx-input').forEach(item => {
            data[item.id] = item.value;
        })
        var xhr = new XMLHttpRequest();
        function bad_response() {
            let el = document.getElementById('submit-button')
            el.classList.remove("rfx-good")
            el.classList.remove("rfx-caution")
            el.classList.add("rfx-warning")
            el = document.getElementById('header-label');
            el.classList.remove("rfx-good")
            el.classList.remove("rfx-caution")
            el.classList.add("rfx-warning")
         }
        xhr.onload = () => {
            if (xhr.response === 'ok') {
                let el = document.getElementById('submit-button')
                        el.classList.add("rfx-good")
                        el.classList.remove("rfx-caution")
                        el.classList.remove("rfx-warning")
                    el = document.getElementById('header-label');
                        el.innerText = "Wifi Settings: Saved"
                        el.classList.add("rfx-good")
                        el.classList.remove("rfx-caution")
                        el.classList.remove("rfx-warning")
                document.querySelectorAll('.rfx-input').forEach(item => {
                    item.classList.remove("rfx-good")
                    item.classList.remove("rfx-caution")
                    item.classList.remove("rfx-warning")
                })
            }
            else {
                document.getElementById('header-label').innerText = "Wifi Settings: Error- Bad Response";
                bad_response()
            }

        };
        xhr.onerror = () => {
            document.getElementById('header-label').innerText = "Wifi Settings: Error- Server";
            bad_response()
        }
        xhr.ontimeout = () => {
            document.getElementById('header-label').innerText = "Wifi Settings: Error- Server Unreachable";
            bad_response()
        }
        xhr.timeout = 2000
        xhr.open("POST", "http://192.168.4.62/server/settings", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        console.log(JSON.stringify(data))
        xhr.send(JSON.stringify(data));
    }
    getServerInfo();
</script>