<!DOCTYPE html>
<html lang="en">
<head>
    <title>RFX CONTROL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="default.css"> <!-- custom css styling-->
</head>

<body>
    <div class="rfx-panel" style="max-width: 400px; margin:auto">
        <label id="header-label">Firmware</label>
        <div>
            <label><b>Firmware: </b></label>
            <label id="firmware" style="float:right">NULL</label>
        </div>
        <div>
            <label><b>Version: </b></label>
            <label id="version"style="float:right">NULL</label>
        </div>
        <div>
            <button id="OTA_file_select" class="rfx-button" onclick="document.getElementById('fileinput').click()">
                <input id="fileinput" type='file' name='update' onchange="document.getElementById('OTA_Execute').classList.remove('disabled'); document.getElementById('progress_label').innerText=document.getElementById('fileinput').value; document.getElementById('progress_container').style.backgroundColor = 'lightgray'">
                Select Firmware for Update
            </button>
            <div id= "progress_container" class="progress" style="margin-top:8px; text-align: center; position: relative; height:26px; background-color: lightgray;">
                <div id="progress" style="position: absolute; background-color: rgb(74, 128, 172); width:0%; height:100% "></div>
                <div id="progress_label" style="position: absolute; top:0px; width:100%;text-align: center;"></div>
            </div>
            <button id="OTA_Execute" class="rfx-button disabled" style="margin-top:8px">Upload</button>
        </div>
    </div>
</body>

<script>
    document.querySelectorAll('.rfx-input').forEach(item => {
        item.addEventListener('change', event => {
            console.log("change")
            function mark(el) {
                with (el.classList) {
                    remove("rfx-good")
                    add("rfx-caution")
                    remove("rfx-warning")
                }
            }
            mark(item)
            mark(document.getElementById('submit-button'))
            document.getElementById('header-label').innerText = "Wifi Settings: Need to submit"
        })
    })
    function getServerInfo() {
        var xhr = new XMLHttpRequest();
        xhr.onload = () => {
            let response = JSON.parse(xhr.responseText)
            document.getElementById("version").innerText  = response.version;
            document.getElementById("firmware").innerText  = response.firmware;
        };
        xhr.onerror = () => {
            setTimeout(getServerInfo, 1000);
            console.log("error")
        }
        xhr.open("GET", "http://192.168.4.62/server/status", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send();
    }
    getServerInfo();
    document.getElementById('OTA_Execute').addEventListener('click', event => {
    var xhr = new XMLHttpRequest();
    function done(msg){
        document.getElementById('OTA_file_select').classList.remove('disabled');
        document.getElementById("progress_label").innerText = msg;
        document.getElementById("progress").style.width = 0;
        getServerInfo();
    }
    xhr.onload = () => {
      if (xhr.response === 'ok') {
        console.log(xhr.response);
        console.log("restart recieved")
        done("Firmware Update Successful");
        document.getElementById("progress_container").style.backgroundColor = "lightGreen";
        
      }
      else {
        console.log(xhr.response);
        done("OTA Bad Response")
        document.getElementById("progress_container").style.backgroundColor = "lightCoral";
      }
    };
    xhr.onerror = () => {
        console.log("restart error")
        done("Update Error");
        document.getElementById("progress_container").style.backgroundColor = "lightCoral";
      
    }
    xhr.ontimeout = () => {
        console.log("restart timeout")
        done("Server Timeout");
        document.getElementById("progress_container").style.backgroundColor = "lightCoral";
    }
    xhr.upload.addEventListener('progress', function (evt) {
      if (evt.lengthComputable) {
        var per = evt.loaded / evt.total;
        console.log(per);
        document.getElementById("progress").style.width = Math.round(per * 100) + "%";
      }
      
     })
    xhr.open("POST", "http://192.168.4.62/update", true);
    let file = document.getElementById("fileinput").files[0];
    var formData = new FormData();
    formData.append("update", file, file.name);
    xhr.file = file;
    document.getElementById('fileinput').value='';
    document.getElementById('OTA_Execute').classList.add('disabled');
    document.getElementById('OTA_file_select').classList.add('disabled');
    document.getElementById("progress_label").innerText = "Uploading..."
    xhr.send(formData);
        return false;
  })
</script>