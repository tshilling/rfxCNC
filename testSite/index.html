<!-- for custom fonts use: https://icomoon.io/app/#/select/font, then copy style.css and fonts folder into main directory-->
<!DOCTYPE html>
<html lang="en">

<head>
  <title>RFX CONTROL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="w3.css"> <!-- W3 min css (like bootstrap) -->
  <link rel="stylesheet" type="text/css" href="default.css"> <!-- custom css styling-->
  <link rel="stylesheet" type="text/css" href="rfx.css"> <!-- custom css styling-->
  
  <link rel="stylesheet" href="style.css"> <!-- Button Icons -->
</head>

<body style="height: 100%;">
  <header id="header_toolbar" class="rfx-header rfx-bar w3-metro-darken">
    <div class="w3-display-container" style="width: 100%;">
      <div id="header-left" class="w3-display-left">
        <a href="#dashboard">
          <div class="w3-button w3-text-blue-gray"><b>RFX</b></div>
        </a>
      </div>
      <div id="header-middle" class="w3-display-middle">

      </div>
      <div id="header-right" class="w3-display-right">
      </div>
    </div>
  </header>
  <div id="main-view" style="margin-top: 32px; margin-bottom: 52px; width:100%">
    <div class="rfx-panel" style="margin:48px 8px 0px 8px;">
      <label>Console</label>
      <textarea  readonly id="console_view" class="rfx-input" name="w3review" rows="10" cols="50" width="100%" onchange="scroll()" style="background-color: black; color:limegreen; font-size: 1rem;">
      </textarea>
      <div>
      
      <input id="code" type="text" placeholder="code to send to machine">
      <button class="rfx-button" id="code_button" onclick="sendcode()">Send</button>  
      </div>
    </div>
  </div>
  <footer id="footer_toolbar" class="rfx-footer rfx-bar w3-metro-darken w3-metro-darken">
    <div class="w3-display-container" style="width: 100%;">
      <div class="w3-display-left"></div>
      <div class="w3-display-middle">&copy ReplicantFX 2020</div>
      <div class="w3-display-right"></div>
    </div>
  </footer>
</body>

<template id="axisTemplate">
  <div class="" style="width: 500px; padding: 8px;">
    <div class="w3-card">
      <div class="rfx-bar  w3-metro-darken">
        <b id="axisLabel">Axis</b>
      </div>
      <div>
        <table WIDTH="100%" class="w3-table w3-bordered width:100%">
          <tr>
            <td style="width: 50px">
              <b>ID</b>
            </td>
            <td style="width: 100px; min-width: 100px;">
              <select id="axisId" class=" rfx-input" onchange='devalidateEngineConfig(this)' name="option"
                style="width: 100%;">
                <option value="" disabled selected>ID</option>
                <option value="X">X</option>
                <option value="Y">Y</option>
                <option value="Z">Z</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="U">U</option>
                <option value="V">V</option>
                <option value="W">W</option>
                <option value="E">E</option>
              </select>
            </td>
            <td style="width:50px;padding-left: 16px;">
              <b>Follow</b>
            </td>
            <td style="width: 100px; min-width: 100px;">
              <select id="axisFollow" class=" rfx-input" onchange='devalidateEngineConfig(this)' name="option"
                style="width: 100%;">
                <option value="" disabled selected></option>
                <option value="X">X</option>
                <option value="Y">Y</option>
                <option value="Z">Z</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="U">U</option>
                <option value="V">V</option>
                <option value="W">W</option>
                <option value="E">E</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>
              <b>Rotary</b>
            </td>
            <td>
              <input class="w3-check rfx-input" onchange='devalidateEngineConfig(this.parentElement)' id="axisRotary"
                type="checkbox" value="false" style="width: 16px;">
            </td>
            <td>
              <b style="padding-left: 8px;">Discrete</b>
            </td>
            <td>
              <input class="w3-check rfx-input" onchange='devalidateEngineConfig(this.parentElement)' id="axisDiscrete"
                type="checkbox" value="false" style="width: 16px;">
            </td>
          </tr>
          <tr>
            <td>
              <b>Min</b><a class="w3-small" style="padding-left: 8px;">(units)</a>
            </td>
            <td>
              <input id="axisMin" class="rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;">
            </td>
            <td style="padding-left: 16px;">
              <b>Max</b><a class="w3-small" style="padding-left: 8px;">(units)</a>
            </td>
            <td>
              <input id="axisMax" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;">
            </td>
          </tr>
          <tr>
            <td>
              <b>Home</b><a class="w3-small" style="padding-left: 8px;">(units)</a>
            </td>
            <td>
              <input id="axisHome" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;">
            </td>
            <td style="padding-left: 16px;">
              <b>Negative</b>
            </td>
            <td>
              <input class="w3-check rfx-input" onchange='devalidateEngineConfig(this)' id="axisHomeNegative"
                type="checkbox" value="false" style="width: 16px;">
            </td>
          </tr>
          <tr>
            <td>
              <b>Step Pin</b>
            </td>
            <td>
              <input id="axisStepPin" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;" min="0" step="1">
            </td>
          </tr>
          <tr>
            <td>
              <b>Dir Pin</b>
            </td>
            <td>
              <input id="axisDirPin" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;" min="0" step="1">
            </td>
            <td style="padding-left: 16px;">
              <b>Invert</b>
            </td>
            <td>
              <input class="w3-check rfx-input" onchange='devalidateEngineConfig(this)' id="axisDirInvert"
                type="checkbox" value="false" style="width: 16px;">
            </td>
          </tr>
          <tr>
            <td>
              <b>Steps/ Unit</b>
            </td>
            <td>
              <input id="axisStepsPerUnit" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;" min="1" step="1">
            </td>
          </tr>
          <tr>
            <td>
              <b>Max Feed</b><a class="w3-small" style="padding-left: 8px;">(u/sec)</a>
            </td>
            <td>
              <input id="axisMaxFeed" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;" min="0">
            </td>
            <td style="padding-left: 16px;">
              <b>Accel</b><a class="w3-small" style="padding-left: 8px;">(u/sec^2)</a>
            </td>
            <td>
              <input id="axisAcceleration" class=" rfx-input" onchange='devalidateEngineConfig(this)' type="number"
                placeholder="0" style="width: 100%;" min="0">
            </td>
          </tr>
        </table>

      </div>
    </div>
  </div>
</template>

<script type="module" src="./engine.js"></script>
<script type="module" src="./server.js"></script>
<script src="./index.js"></script>
<script>
    let ws = new WebSocket("ws://192.168.4.62/ws");

    ws.onopen = function() {             
      // Web Socket is connected, send data using send()
      ws.send("Message to send");
    };

    ws.onmessage = function (evt) { 
      var received_msg = evt.data;
        if(received_msg)
          document.getElementById("console_view").innerHTML += received_msg;
        let innerText = document.getElementById("console_view").innerHTML;
        console.log(innerText.length)
        if(innerText.length > 1000){
          innerText = innerText.substr(innerText.length-1000);
          document.getElementById("console_view").innerHTML = innerText;
        }
        var textarea = document.getElementById('console_view');
        textarea.scrollTop = textarea.scrollHeight;
    };

    ws.onclose = function() { 
    };
    ws.onerror = function(evt){
      console.log("error: "+evt)
    }
    function sendcode(){
      console.log("value: "+document.getElementById("code").value)
      var xhr = new XMLHttpRequest();
      function bad_response() {

      }
      xhr.onload = () => {
        if (xhr.response === 'ok') {
          console.log("code recieved")
        }
        else {
          console.log("code bad response")
        }

      };
      xhr.onerror = () => {
        console.log("code error")
      }
      xhr.ontimeout = () => {
        console.log("code timeout")
      }
      xhr.timeout = 2000
      var data = new FormData();
      data.append('code', document.getElementById("code").value);
      document.getElementById("code").value="";
      xhr.open("POST", "http://192.168.4.62/engine/api", true);
      //xhr.setRequestHeader("Content-Type", "text/html");
      xhr.send(data);
    }
    setInterval(function(){
      var textarea = document.getElementById('console_view');
        textarea.scrollTop = textarea.scrollHeight;
    }, 1000);
</script>
